<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Different Output between Stata and ggeffects • ggeffects</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Different Output between Stata and ggeffects">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ggeffects</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/effectsatvalues.html">Marginal Effects at Specific Values</a>
    </li>
    <li>
      <a href="../articles/marginaleffects.html">Marginal Effects of Regression Models</a>
    </li>
    <li>
      <a href="../articles/plotmethod.html">Plotting Marginal Effects</a>
    </li>
    <li>
      <a href="../articles/randomeffects.html">Marginal Effects for Random Effects Models</a>
    </li>
    <li>
      <a href="../articles/stata.html">Different Output between Stata and ggeffects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Different Output between Stata and ggeffects</h1>
                        <h4 class="author">Daniel Lüdecke</h4>
            
            <h4 class="date">2019-01-03</h4>
      
      
      <div class="hidden name"><code>stata.Rmd</code></div>

    </div>

    
    
<div id="why-is-the-output-from-stata-different-from-the-output-from-ggeffect" class="section level1">
<h1 class="hasAnchor">
<a href="#why-is-the-output-from-stata-different-from-the-output-from-ggeffect" class="anchor"></a>Why is the output from Stata different from the output from ggeffect?</h1>
<p>Stata’s equivalent to the marginal effects produced by <em>ggeffects</em> is the <code>margins</code>-command. However, the results are not always identical. For models from non-gaussian families, point estimates for the marginal effects are identical, but the confidence intervals differ.</p>
<p>Here is an explanation, why there is a difference. First, we fit a logistic regression model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">5</span>)

data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(
  <span class="dt">outcome =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="fl">0.5</span>),
  <span class="dt">var1 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),
  <span class="dt">var2 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">7</span>)
)

m &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(
  outcome <span class="op">~</span><span class="st"> </span>var1 <span class="op">*</span><span class="st"> </span>var2, 
  <span class="dt">data =</span> data, 
  <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">binomial</a></span>(<span class="dt">link =</span> <span class="st">"logit"</span>)
)</code></pre></div>
<div id="example-with-graphical-output" class="section level2">
<h2 class="hasAnchor">
<a href="#example-with-graphical-output" class="anchor"></a>Example with graphical output</h2>
<div id="the-stata-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#the-stata-plot" class="anchor"></a>The Stata plot</h3>
<p>This is the code in Stata to produce a marginal effects plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">use data.dta, clear
quietly logit outcome c.var1##c.var2
quietly margins, <span class="kw">at</span>(<span class="dt">var2 =</span> (<span class="op">-</span><span class="dv">8</span>(<span class="fl">0.5</span>)<span class="dv">28</span>) <span class="dt">var1 =</span> (<span class="dv">0</span> <span class="dv">1</span>))
marginsplot</code></pre></div>
<p>The resulting image looks like this.</p>
<p><img src="vignette-stata-1.png" width="100%"></p>
</div>
<div id="the-ggeffects-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#the-ggeffects-plot" class="anchor"></a>The ggeffects plot</h3>
<p>When we use <em>ggeffects</em>, the plot slighlty differs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggeffects)
<span class="kw"><a href="../reference/ggpredict.html">ggpredict</a></span>(m, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"var2"</span>, <span class="st">"var1"</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/plot.html">plot</a></span>()</code></pre></div>
<p><img src="stata_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>As we can see, the confidence intervals in the Stata plot are outside the plausible range of <code>[0, 1]</code>, which means that the predicted uncertainty from the Stata output has a probability higher than 1 and lower than 0, while <code><a href="../reference/ggpredict.html">ggpredict()</a></code> computes confidence intervals <em>within</em> the possible range.</p>
</div>
</div>
<div id="example-with-numerical-output" class="section level2">
<h2 class="hasAnchor">
<a href="#example-with-numerical-output" class="anchor"></a>Example with numerical output</h2>
<p>Here is another example with numeric output. First, we fit a model with survey-design.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(survey)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">123</span>)

df1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(
  <span class="dt">id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dt">by =</span> <span class="dv">1</span>),
  <span class="dt">gender =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.50</span>)),
  <span class="dt">working =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.40</span>)),
  <span class="dt">income  =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dv">0</span><span class="op">:</span><span class="dv">100000</span>, <span class="dv">100</span>),
  <span class="dt">pweight =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dv">50</span><span class="op">:</span><span class="dv">500</span>, <span class="dv">100</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)
)
  
des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(
  <span class="dt">id =</span> <span class="op">~</span>id,
  <span class="dt">weights =</span> <span class="op">~</span>pweight,
  <span class="dt">data =</span> df1
)

m &lt;-<span class="st"> </span><span class="kw">svyglm</span>(
  gender <span class="op">~</span><span class="st"> </span>working <span class="op">*</span><span class="st"> </span>income,
  <span class="dt">family =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">quasibinomial</a></span>(),
  <span class="dt">data =</span> df1,
  <span class="dt">design =</span> des
)</code></pre></div>
<p>The same exact analysis in R (using <code><a href="../reference/ggpredict.html">ggpredict()</a></code>) and Stata slightly differs. We get the same point estimate, but different confidence intervals again.</p>
<div id="the-stata-output" class="section level3">
<h3 class="hasAnchor">
<a href="#the-stata-output" class="anchor"></a>The Stata output</h3>
<pre><code>margins, at(working=(0 1) income=(100 1000 10000))

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   .4906395   .1375135     3.57   0.001     .2177829    .7634961
          2  |   .4893027   .1356353     3.61   0.000     .2201729    .7584325
          3  |   .4759466   .1173992     4.05   0.000     .2430012     .708892
          4  |    .579421   .1687542     3.43   0.001      .244576    .9142659
          5  |   .5773197    .166619     3.46   0.001     .2467115    .9079279
          6  |   .5561654   .1454702     3.82   0.000      .267521    .8448097
------------------------------------------------------------------------------</code></pre>
</div>
<div id="the-ggeffects-output" class="section level3">
<h3 class="hasAnchor">
<a href="#the-ggeffects-output" class="anchor"></a>The ggeffects output</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/ggpredict.html">ggpredict</a></span>(m, <span class="dt">terms =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"working [0, 1]"</span>, <span class="st">"income [100, 1000, 10000]"</span>))
<span class="co">#&gt; </span>
<span class="co">#&gt; # Predicted probabilities of gender </span>
<span class="co">#&gt; # x = working </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # income = 100</span>
<span class="co">#&gt;  x predicted std.error conf.low conf.high</span>
<span class="co">#&gt;  0     0.491     0.550    0.247     0.739</span>
<span class="co">#&gt;  1     0.579     0.692    0.262     0.843</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # income = 1000</span>
<span class="co">#&gt;  x predicted std.error conf.low conf.high</span>
<span class="co">#&gt;  0     0.489     0.543    0.248     0.735</span>
<span class="co">#&gt;  1     0.577     0.683    0.264     0.839</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # income = 10000</span>
<span class="co">#&gt;  x predicted std.error conf.low conf.high</span>
<span class="co">#&gt;  0     0.476     0.471    0.265     0.696</span>
<span class="co">#&gt;  1     0.556     0.589    0.283     0.799</span></code></pre></div>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>I guess Stata is getting the confidence intervals wrong here. It looks like predictions and standard errors returned in Stata are on the (transformed) response scale. The confidence intervals are then computed by <code>estimate +/- 1.96 * standard error</code>, which may lead to confidence intervals that are out of reasonable bounds (e.g. above 1 or below 0 for predicted probabilities).</p>
<p>The <em>transformed estimate</em> (on the response scale) is always between 0 and 1, and the same is true for the <em>transformed standard errors</em>. However, adding or substracting approx. 2 * <em>transformed</em> SE to the <em>transformed</em> estimate does no longer ensure that the confidence intervals are within the correct range.</p>
<p>The more precise way to do the calculation is to calculate estimates, standard errors and confidence intervals on the (untransformed) scale of the linear predictor and then back-transform.</p>
<p>See examples:</p>
<div id="less-appropriate-approach" class="section level3">
<h3 class="hasAnchor">
<a href="#less-appropriate-approach" class="anchor"></a>Less appropriate approach</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">newdata &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(
  <span class="dt">working =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)),
  <span class="dt">income =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">10000</span>)
)

prdat &lt;-
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(
    m,
    <span class="dt">newdata =</span> newdata,
    <span class="dt">type =</span> <span class="st">"response"</span>,
    <span class="dt">se.fit =</span> <span class="ot">TRUE</span>
  )

pr &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(prdat)

<span class="co"># almost match STATA output, but computation is imprecise</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(
  <span class="dt">est =</span> pr, 
  <span class="dt">lower =</span> pr <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(.<span class="dv">975</span>) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(prdat, <span class="st">"var"</span>)),
  <span class="dt">upper =</span> pr <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(.<span class="dv">975</span>) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(prdat, <span class="st">"var"</span>))
)
<span class="co">#&gt;         est     lower     upper</span>
<span class="co">#&gt; 1 0.4906395 0.2211180 0.7601610</span>
<span class="co">#&gt; 2 0.5794210 0.2486688 0.9101731</span>
<span class="co">#&gt; 3 0.4893027 0.2234625 0.7551430</span>
<span class="co">#&gt; 4 0.5773197 0.2507525 0.9038869</span>
<span class="co">#&gt; 5 0.4759466 0.2458485 0.7060447</span>
<span class="co">#&gt; 6 0.5561654 0.2710491 0.8412817</span></code></pre></div>
</div>
<div id="more-precise-approach" class="section level3">
<h3 class="hasAnchor">
<a href="#more-precise-approach" class="anchor"></a>More precise approach</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prdat &lt;-
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(
    m,
    <span class="dt">newdata =</span> newdata,
    <span class="dt">type =</span> <span class="st">"link"</span>,
    <span class="dt">se.fit =</span> <span class="ot">TRUE</span>
  )

linv &lt;-<span class="st"> </span>sjstats<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/sjstats/topics/pred_vars">link_inverse</a></span>(m)

<span class="co"># more precise approach, matches the output from ggpredict()</span>
pr &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(prdat)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(
  <span class="dt">est =</span> <span class="kw">linv</span>(pr), 
  <span class="dt">lower =</span> <span class="kw">linv</span>(pr <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(.<span class="dv">975</span>) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(prdat, <span class="st">"var"</span>))),
  <span class="dt">upper =</span> <span class="kw">linv</span>(pr <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(.<span class="dv">975</span>) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/attr">attr</a></span>(prdat, <span class="st">"var"</span>)))
)
<span class="co">#&gt;         est     lower     upper</span>
<span class="co">#&gt; 1 0.4906395 0.2467707 0.7390463</span>
<span class="co">#&gt; 2 0.5794210 0.2617570 0.8425931</span>
<span class="co">#&gt; 3 0.4893027 0.2484972 0.7351775</span>
<span class="co">#&gt; 4 0.5773197 0.2637649 0.8388980</span>
<span class="co">#&gt; 5 0.4759466 0.2652582 0.6955592</span>
<span class="co">#&gt; 6 0.5561654 0.2830412 0.7990959</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#why-is-the-output-from-stata-different-from-the-output-from-ggeffect">Why is the output from Stata different from the output from ggeffect?</a><ul class="nav nav-pills nav-stacked">
<li><a href="#example-with-graphical-output">Example with graphical output</a></li>
      <li><a href="#example-with-numerical-output">Example with numerical output</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Daniel Lüdecke.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
